Data preparation
================

``` r
pacman::p_load(
    rio,            # import and export files
    here,           # locate files 
    tidyverse,      # data management and visualization
    skimr,
    splines,
    gnm,            # Generalized Nonlinear Models
    Epi             # Statistical Analysis in Epidemiology
)
```

# Check data

``` r
# check data #-----------
(df_valencia <- rio::import(here("valencia.csv")) %>% tibble())
```

    ## # A tibble: 1,826 × 12
    ##    city     date       year month   day   dow   all allage1 allage2 tmean    rh  pm10
    ##    <chr>    <chr>     <int> <int> <int> <int> <int>   <int>   <int> <dbl> <dbl> <dbl>
    ##  1 Valencia 01jan2002  2002     1     1     2    31       5      26  8.90  85    17.8
    ##  2 Valencia 02jan2002  2002     1     2     3    29       3      26  8.5   89.4  21.7
    ##  3 Valencia 03jan2002  2002     1     3     4    23       4      19 10.8   86.8  43.2
    ##  4 Valencia 04jan2002  2002     1     4     5    17       2      15  9.60  88.1  19.8
    ##  5 Valencia 05jan2002  2002     1     5     6    19       6      13  9.20  88.8  15.9
    ##  6 Valencia 06jan2002  2002     1     6     0    26       4      22  9.70  87.2  20.5
    ##  7 Valencia 07jan2002  2002     1     7     1    25       6      19  8.80  72.4  48.9
    ##  8 Valencia 08jan2002  2002     1     8     2    21       0      21  9.40  78.5  26  
    ##  9 Valencia 09jan2002  2002     1     9     3    15       3      12  8.80  83.6  18.7
    ## 10 Valencia 10jan2002  2002     1    10     4    19       1      18  9.60  76.2  39.6
    ## # ℹ 1,816 more rows

``` r
skimr::skim(df_valencia)
```

|                                                  |             |
|:-------------------------------------------------|:------------|
| Name                                             | df_valencia |
| Number of rows                                   | 1826        |
| Number of columns                                | 12          |
| \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_   |             |
| Column type frequency:                           |             |
| character                                        | 2           |
| numeric                                          | 10          |
| \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ |             |
| Group variables                                  | None        |

Data summary

**Variable type: character**

| skim_variable | n_missing | complete_rate | min | max | empty | n_unique | whitespace |
|:--------------|----------:|--------------:|----:|----:|------:|---------:|-----------:|
| city          |         0 |             1 |   8 |   8 |     0 |        1 |          0 |
| date          |         0 |             1 |   9 |   9 |     0 |     1826 |          0 |

**Variable type: numeric**

| skim_variable | n_missing | complete_rate | mean | sd | p0 | p25 | p50 | p75 | p100 | hist |
|:---|---:|---:|---:|---:|---:|---:|---:|---:|---:|:---|
| year | 0 | 1 | 2004.00 | 1.41 | 2002.0 | 2003.00 | 2004.00 | 2005.0 | 2006.0 | ▇▇▇▇▇ |
| month | 0 | 1 | 6.52 | 3.45 | 1.0 | 4.00 | 7.00 | 10.0 | 12.0 | ▇▅▅▅▇ |
| day | 0 | 1 | 15.73 | 8.80 | 1.0 | 8.00 | 16.00 | 23.0 | 31.0 | ▇▇▇▇▆ |
| dow | 0 | 1 | 3.00 | 2.00 | 0.0 | 1.00 | 3.00 | 5.0 | 6.0 | ▇▃▃▃▇ |
| all | 0 | 1 | 16.92 | 4.79 | 4.0 | 14.00 | 16.00 | 20.0 | 39.0 | ▂▇▅▁▁ |
| allage1 | 0 | 1 | 2.84 | 1.68 | 0.0 | 2.00 | 3.00 | 4.0 | 12.0 | ▇▇▂▁▁ |
| allage2 | 0 | 1 | 14.08 | 4.38 | 3.0 | 11.00 | 14.00 | 17.0 | 35.0 | ▂▇▅▁▁ |
| tmean | 0 | 1 | 17.74 | 6.31 | 1.8 | 12.40 | 17.70 | 23.2 | 31.0 | ▁▇▇▇▅ |
| rh | 0 | 1 | 64.33 | 11.38 | 29.2 | 56.93 | 65.80 | 72.5 | 90.7 | ▁▃▇▇▂ |
| pm10 | 0 | 1 | 29.70 | 9.18 | 9.0 | 23.80 | 28.28 | 34.0 | 100.7 | ▇▇▁▁▁ |

``` r
(df_london <- rio::import(here("london.csv")) %>% tibble())
```

    ## # A tibble: 1,826 × 10
    ##    city   date       year month   day   dow   all   tmean    rh  pm10
    ##    <chr>  <chr>     <int> <int> <int> <int> <int>   <dbl> <dbl> <dbl>
    ##  1 London 01jan2002  2002     1     1     2   199 -0.225   75.7  71.7
    ##  2 London 02jan2002  2002     1     2     3   231  0.0875  77.5  40.2
    ##  3 London 03jan2002  2002     1     3     4   210  0.850   81.3  41.8
    ##  4 London 04jan2002  2002     1     4     5   203  0.538   85.4  50.4
    ##  5 London 05jan2002  2002     1     5     6   224  4.25    93.5  49.4
    ##  6 London 06jan2002  2002     1     6     0   198  7.07    96.4  31.1
    ##  7 London 07jan2002  2002     1     7     1   180  5.19    93.5  48.6
    ##  8 London 08jan2002  2002     1     8     2   188  3.51    81.5  48.6
    ##  9 London 09jan2002  2002     1     9     3   168  3.22    88.3  59.2
    ## 10 London 10jan2002  2002     1    10     4   194  5.32    85.4  48.7
    ## # ℹ 1,816 more rows

``` r
skimr::skim(df_london)
```

|                                                  |           |
|:-------------------------------------------------|:----------|
| Name                                             | df_london |
| Number of rows                                   | 1826      |
| Number of columns                                | 10        |
| \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_   |           |
| Column type frequency:                           |           |
| character                                        | 2         |
| numeric                                          | 8         |
| \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ |           |
| Group variables                                  | None      |

Data summary

**Variable type: character**

| skim_variable | n_missing | complete_rate | min | max | empty | n_unique | whitespace |
|:--------------|----------:|--------------:|----:|----:|------:|---------:|-----------:|
| city          |         0 |             1 |   6 |   6 |     0 |        1 |          0 |
| date          |         0 |             1 |   0 |   9 |     1 |     1826 |          0 |

**Variable type: numeric**

| skim_variable | n_missing | complete_rate | mean | sd | p0 | p25 | p50 | p75 | p100 | hist |
|:---|---:|---:|---:|---:|---:|---:|---:|---:|---:|:---|
| year | 1 | 1 | 2004.00 | 1.41 | 2002.00 | 2003.00 | 2004.00 | 2005.00 | 2006.00 | ▇▇▇▇▇ |
| month | 1 | 1 | 6.52 | 3.45 | 1.00 | 4.00 | 7.00 | 10.00 | 12.00 | ▇▅▅▅▇ |
| day | 1 | 1 | 15.72 | 8.80 | 1.00 | 8.00 | 16.00 | 23.00 | 31.00 | ▇▇▇▇▆ |
| dow | 1 | 1 | 3.00 | 2.00 | 0.00 | 1.00 | 3.00 | 5.00 | 6.00 | ▇▃▃▃▇ |
| all | 0 | 1 | 149.51 | 20.70 | 99.00 | 135.00 | 148.00 | 162.00 | 280.00 | ▃▇▂▁▁ |
| tmean | 0 | 1 | 11.72 | 5.65 | -1.40 | 7.51 | 11.47 | 16.20 | 28.17 | ▃▇▇▆▁ |
| rh | 0 | 1 | 69.10 | 13.70 | 31.23 | 58.69 | 69.61 | 80.36 | 98.86 | ▁▅▇▇▃ |
| pm10 | 1 | 1 | 41.46 | 15.21 | 8.10 | 30.70 | 39.73 | 50.50 | 99.60 | ▃▇▅▁▁ |

# Data preparation

``` r
# prepare data #-----------
```

### Generate time-stratified strata

“1826 observations were split into 420 stratum sets defined by
day-of-week within-month and year.”

``` r
a1 <- df_valencia %>% 
    mutate(across(.cols = c(month, year, dow),
                  as.factor),
           stratum = as.factor(year:month:dow))

a1 %>% print(n = 20)
```

    ## # A tibble: 1,826 × 13
    ##    city     date      year  month   day dow     all allage1 allage2 tmean    rh  pm10 stratum 
    ##    <chr>    <chr>     <fct> <fct> <int> <fct> <int>   <int>   <int> <dbl> <dbl> <dbl> <fct>   
    ##  1 Valencia 01jan2002 2002  1         1 2        31       5      26  8.90  85    17.8 2002:1:2
    ##  2 Valencia 02jan2002 2002  1         2 3        29       3      26  8.5   89.4  21.7 2002:1:3
    ##  3 Valencia 03jan2002 2002  1         3 4        23       4      19 10.8   86.8  43.2 2002:1:4
    ##  4 Valencia 04jan2002 2002  1         4 5        17       2      15  9.60  88.1  19.8 2002:1:5
    ##  5 Valencia 05jan2002 2002  1         5 6        19       6      13  9.20  88.8  15.9 2002:1:6
    ##  6 Valencia 06jan2002 2002  1         6 0        26       4      22  9.70  87.2  20.5 2002:1:0
    ##  7 Valencia 07jan2002 2002  1         7 1        25       6      19  8.80  72.4  48.9 2002:1:1
    ##  8 Valencia 08jan2002 2002  1         8 2        21       0      21  9.40  78.5  26   2002:1:2
    ##  9 Valencia 09jan2002 2002  1         9 3        15       3      12  8.80  83.6  18.7 2002:1:3
    ## 10 Valencia 10jan2002 2002  1        10 4        19       1      18  9.60  76.2  39.6 2002:1:4
    ## 11 Valencia 11jan2002 2002  1        11 5        24       3      21 10.7   71.2  53.1 2002:1:5
    ## 12 Valencia 12jan2002 2002  1        12 6        21       2      19  8.10  78.9  45.2 2002:1:6
    ## 13 Valencia 13jan2002 2002  1        13 0        24       5      19  7.80  79.5  45.4 2002:1:0
    ## 14 Valencia 14jan2002 2002  1        14 1        17       2      15 12.6   60.9  51.6 2002:1:1
    ## 15 Valencia 15jan2002 2002  1        15 2        29       3      26 10.1   64.3  38.2 2002:1:2
    ## 16 Valencia 16jan2002 2002  1        16 3        16       2      14 11.3   48.1  44.1 2002:1:3
    ## 17 Valencia 17jan2002 2002  1        17 4        18       3      15  8.40  60.2  50.5 2002:1:4
    ## 18 Valencia 18jan2002 2002  1        18 5        18       1      17  9     71.3  50.6 2002:1:5
    ## 19 Valencia 19jan2002 2002  1        19 6        28       1      27  9.20  69.1  43.6 2002:1:6
    ## 20 Valencia 20jan2002 2002  1        20 0        24       1      23 10     71.9  29.9 2002:1:0
    ## # ℹ 1,806 more rows

``` r
a1 %>% count(stratum)
```

    ## # A tibble: 420 × 2
    ##    stratum      n
    ##    <fct>    <int>
    ##  1 2002:1:0     4
    ##  2 2002:1:1     4
    ##  3 2002:1:2     5
    ##  4 2002:1:3     5
    ##  5 2002:1:4     5
    ##  6 2002:1:5     4
    ##  7 2002:1:6     4
    ##  8 2002:2:0     4
    ##  9 2002:2:1     4
    ## 10 2002:2:2     4
    ## # ℹ 410 more rows

### Generate ‘ind’ = sum of events in each stratum

``` r
a1 %>%
    group_by(stratum) %>% 
    summarise(ind = sum(all))
```

    ## # A tibble: 420 × 2
    ##    stratum    ind
    ##    <fct>    <int>
    ##  1 2002:1:0    97
    ##  2 2002:1:1    80
    ##  3 2002:1:2   116
    ##  4 2002:1:3   113
    ##  5 2002:1:4   109
    ##  6 2002:1:5    82
    ##  7 2002:1:6    93
    ##  8 2002:2:0    77
    ##  9 2002:2:1    94
    ## 10 2002:2:2   110
    ## # ℹ 410 more rows

### Generate lagX for temperature, humidity, and PM10

``` r
df_valencia %>% 
    select(tmean, rh, pm10) %>% 
    mutate(across(.cols = c(tmean, rh, pm10),
                  ~ dplyr::lag(.x, n = 1),
                  .names = "{.col}_l1"),
           across(.cols = c(tmean, rh, pm10),
                  ~ dplyr::lag(.x, n = 3),
                  .names = "{.col}_l3"))
```

    ## # A tibble: 1,826 × 9
    ##    tmean    rh  pm10 tmean_l1 rh_l1 pm10_l1 tmean_l3 rh_l3 pm10_l3
    ##    <dbl> <dbl> <dbl>    <dbl> <dbl>   <dbl>    <dbl> <dbl>   <dbl>
    ##  1  8.90  85    17.8    NA     NA      NA      NA     NA      NA  
    ##  2  8.5   89.4  21.7     8.90  85      17.8    NA     NA      NA  
    ##  3 10.8   86.8  43.2     8.5   89.4    21.7    NA     NA      NA  
    ##  4  9.60  88.1  19.8    10.8   86.8    43.2     8.90  85      17.8
    ##  5  9.20  88.8  15.9     9.60  88.1    19.8     8.5   89.4    21.7
    ##  6  9.70  87.2  20.5     9.20  88.8    15.9    10.8   86.8    43.2
    ##  7  8.80  72.4  48.9     9.70  87.2    20.5     9.60  88.1    19.8
    ##  8  9.40  78.5  26       8.80  72.4    48.9     9.20  88.8    15.9
    ##  9  8.80  83.6  18.7     9.40  78.5    26       9.70  87.2    20.5
    ## 10  9.60  76.2  39.6     8.80  83.6    18.7     8.80  72.4    48.9
    ## # ℹ 1,816 more rows

### Generate splines for environmental factor adjustment

``` r
ns(df_valencia$tmean, df = 6)
```

    ##                    1            2            3             4            5             6
    ##    [1,] 2.022109e-01 0.000000e+00 0.000000e+00 -1.848478e-01 4.806042e-01 -2.957564e-01
    ##    [2,] 1.699237e-01 0.000000e+00 0.000000e+00 -1.848623e-01 4.806420e-01 -2.957797e-01
    ##    [3,] 4.118672e-01 0.000000e+00 0.000000e+00 -1.566839e-01 4.073782e-01 -2.506943e-01
    ##    [4,] 2.681103e-01 0.000000e+00 0.000000e+00 -1.801325e-01 4.683445e-01 -2.882120e-01
    ##    [5,] 2.289416e-01 0.000000e+00 0.000000e+00 -1.835815e-01 4.773119e-01 -2.937304e-01
    ##    [6,] 2.785550e-01 0.000000e+00 0.000000e+00 -1.789446e-01 4.652559e-01 -2.863114e-01
    ##    [7,] 1.937866e-01 0.000000e+00 0.000000e+00 -1.850274e-01 4.810711e-01 -2.960438e-01
    ##    [8,] 2.480107e-01 0.000000e+00 0.000000e+00 -1.821142e-01 4.734969e-01 -2.913827e-01
    ##    [9,] 1.937866e-01 0.000000e+00 0.000000e+00 -1.850274e-01 4.810711e-01 -2.960438e-01
    ##   [10,] 2.681103e-01 0.000000e+00 0.000000e+00 -1.801325e-01 4.683445e-01 -2.882120e-01
    ##   [11,] 3.982902e-01 0.000000e+00 0.000000e+00 -1.594351e-01 4.145313e-01 -2.550962e-01
    ##   [12,] 1.412705e-01 0.000000e+00 0.000000e+00 -1.830632e-01 4.759644e-01 -2.929012e-01
    ##   [13,] 1.220347e-01 0.000000e+00 0.000000e+00 -1.805888e-01 4.695309e-01 -2.889421e-01
    ##   [14,] 6.685226e-01 2.027000e-02 0.000000e+00 -8.809350e-02 2.290431e-01 -1.409496e-01
    ##   [15,] 3.230457e-01 0.000000e+00 0.000000e+00 -1.728394e-01 4.493825e-01 -2.765431e-01
    ##   [16,] 4.841112e-01 1.336157e-04 0.000000e+00 -1.406669e-01 3.657339e-01 -2.250670e-01
    ##   [17,] 1.624282e-01 0.000000e+00 0.000000e+00 -1.845783e-01 4.799037e-01 -2.953254e-01
    ##   [18,] 2.108760e-01 0.000000e+00 0.000000e+00 -1.845481e-01 4.798250e-01 -2.952769e-01
    ##   [19,] 2.289416e-01 0.000000e+00 0.000000e+00 -1.835815e-01 4.773119e-01 -2.937304e-01
    ##   [20,] 3.115094e-01 0.000000e+00 0.000000e+00 -1.745721e-01 4.538875e-01 -2.793154e-01
    ##   [21,] 2.383491e-01 0.000000e+00 0.000000e+00 -1.829113e-01 4.755693e-01 -2.926581e-01
    ##   [22,] 6.798622e-01 2.431311e-02 0.000000e+00 -8.387690e-02 2.180799e-01 -1.342030e-01
    ##   [23,] 7.258403e-01 1.768659e-01 2.023075e-04 -2.774578e-02 7.213902e-02 -4.439324e-02
    ##   [24,] 7.437567e-01 1.206946e-01 0.000000e+00 -3.873565e-02 1.007127e-01 -6.197704e-02
    ##   [25,] 6.173024e-01 8.551406e-03 0.000000e+00 -1.050410e-01 2.731066e-01 -1.680656e-01
    ##   [26,] 7.412697e-01 1.336005e-01 3.161055e-06 -3.575734e-02 9.296910e-02 -5.721175e-02
    ##   [27,] 6.685226e-01 2.027000e-02 0.000000e+00 -8.809350e-02 2.290431e-01 -1.409496e-01
    ##   [28,] 4.841112e-01 1.336157e-04 0.000000e+00 -1.406669e-01 3.657339e-01 -2.250670e-01
    ##   [29,] 4.399397e-01 0.000000e+00 0.000000e+00 -1.507231e-01 3.918799e-01 -2.411569e-01
    ##   [30,] 2.197851e-01 0.000000e+00 0.000000e+00 -1.841265e-01 4.787290e-01 -2.946025e-01
    ##   [31,] 7.429701e-01 8.697889e-02 0.000000e+00 -4.858504e-02 1.263211e-01 -7.773606e-02
    ##   [32,] 6.173024e-01 8.551406e-03 0.000000e+00 -1.050410e-01 2.731066e-01 -1.680656e-01
    ##   [33,] 2.480107e-01 0.000000e+00 0.000000e+00 -1.821142e-01 4.734969e-01 -2.913827e-01
    ##   [34,] 5.595776e-01 2.533750e-03 0.000000e+00 -1.215942e-01 3.161450e-01 -1.945508e-01
    ##   [35,] 7.094064e-01 3.958984e-02 0.000000e+00 -7.145043e-02 1.857711e-01 -1.143207e-01
    ##   [36,] 7.258403e-01 1.768659e-01 2.023075e-04 -2.774578e-02 7.213902e-02 -4.439324e-02
    ##   [37,] 7.374162e-01 1.473055e-01 2.528844e-05 -3.293575e-02 8.563296e-02 -5.269720e-02
    ##   [38,] 6.904960e-01 2.886100e-02 0.000000e+00 -7.969024e-02 2.071946e-01 -1.275044e-01
    ##   [39,] 3.348633e-01 0.000000e+00 0.000000e+00 -1.709663e-01 4.445123e-01 -2.735461e-01
    ##   [40,] 5.294732e-01 1.068926e-03 0.000000e+00 -1.295047e-01 3.367121e-01 -2.072075e-01
    ##   [41,] 7.003640e-01 3.394334e-02 0.000000e+00 -7.554445e-02 1.964156e-01 -1.208711e-01
    ##   [42,] 4.691753e-01 3.958984e-05 0.000000e+00 -1.441564e-01 3.748067e-01 -2.306502e-01
    ##   [43,] 3.469656e-01 0.000000e+00 0.000000e+00 -1.689510e-01 4.392727e-01 -2.703217e-01
    ##   [44,] 5.143201e-01 6.185913e-04 0.000000e+00 -1.333301e-01 3.466583e-01 -2.133282e-01
    ##   [45,] 6.033314e-01 6.586760e-03 0.000000e+00 -1.092436e-01 2.840333e-01 -1.747897e-01
    ##   [46,] 4.118672e-01 0.000000e+00 0.000000e+00 -1.566839e-01 4.073782e-01 -2.506943e-01
    ##   [47,] 1.937866e-01 0.000000e+00 0.000000e+00 -1.850274e-01 4.810711e-01 -2.960438e-01
    ##   [48,] 2.579300e-01 0.000000e+00 0.000000e+00 -1.811885e-01 4.710901e-01 -2.899016e-01
    ##   [49,] 2.108760e-01 0.000000e+00 0.000000e+00 -1.845481e-01 4.798250e-01 -2.952769e-01
    ##   [50,] 2.108760e-01 0.000000e+00 0.000000e+00 -1.845481e-01 4.798250e-01 -2.952769e-01
    ##   [51,] 4.991795e-01 3.167187e-04 0.000000e+00 -1.370545e-01 3.563417e-01 -2.192872e-01
    ##   [52,] 6.055925e-01 3.515845e-01 8.673935e-03 -9.758746e-03 2.537274e-02 -1.561399e-02
    ##   [53,] 7.309811e-01 6.021120e-02 0.000000e+00 -5.958822e-02 1.549294e-01 -9.534115e-02
    ##   [54,] 7.445568e-01 9.740586e-02 0.000000e+00 -4.515915e-02 1.174138e-01 -7.225464e-02
    ##   [55,] 6.996702e-01 2.256537e-01 1.084242e-03 -2.103029e-02 5.467875e-02 -3.364846e-02
    ##   [56,] 6.798622e-01 2.431311e-02 0.000000e+00 -8.387690e-02 2.180799e-01 -1.342030e-01
    ##   [57,] 3.277303e-01 5.933740e-01 7.709489e-02 -5.146241e-04 1.338023e-03 -8.233986e-04
    ##   [58,] 6.820161e-02 5.919538e-01 3.370609e-01  2.513971e-03 7.013223e-04 -4.315829e-04
    ##   [59,] 8.450799e-02 6.127959e-01 3.012708e-01  1.287148e-03 3.590757e-04 -2.209696e-04
    ##   [60,] 6.364185e-01 3.147017e-01 5.462303e-03 -1.240739e-02 3.225920e-02 -1.985182e-02
    ##   [61,] 7.412697e-01 1.336005e-01 3.161055e-06 -3.575734e-02 9.296910e-02 -5.721175e-02
    ##   [62,] 2.383491e-01 0.000000e+00 0.000000e+00 -1.829113e-01 4.755693e-01 -2.926581e-01
    ##   [63,] 2.785550e-01 0.000000e+00 0.000000e+00 -1.789446e-01 4.652559e-01 -2.863114e-01
    ##   [64,] 3.115094e-01 0.000000e+00 0.000000e+00 -1.745721e-01 4.538875e-01 -2.793154e-01
    ##   [65,] 6.904960e-01 2.886100e-02 0.000000e+00 -7.969024e-02 2.071946e-01 -1.275044e-01
    ##   [66,] 5.890136e-01 4.948730e-03 0.000000e+00 -1.134106e-01 2.948675e-01 -1.814569e-01
    ##   [67,] 5.744091e-01 3.607624e-03 0.000000e+00 -1.175311e-01 3.055809e-01 -1.880498e-01
    ##   [68,] 7.175633e-01 4.583019e-02 0.000000e+00 -6.741910e-02 1.752897e-01 -1.078706e-01
    ##   [69,] 7.094064e-01 3.958984e-02 0.000000e+00 -7.145043e-02 1.857711e-01 -1.143207e-01
    ##   [70,] 4.841112e-01 1.336157e-04 0.000000e+00 -1.406669e-01 3.657339e-01 -2.250670e-01
    ##   [71,] 7.361224e-01 6.841125e-02 0.000000e+00 -5.581049e-02 1.451073e-01 -8.929678e-02
    ##   [72,] 6.439651e-01 1.357932e-02 0.000000e+00 -9.657287e-02 2.510895e-01 -1.545166e-01
    ##   [73,] 7.175633e-01 4.583019e-02 0.000000e+00 -6.741910e-02 1.752897e-01 -1.078706e-01
    ##   [74,] 6.888294e-01 2.428548e-01 1.618460e-03 -1.906005e-02 4.955612e-02 -3.049607e-02
    ##   [75,] 7.094064e-01 3.958984e-02 0.000000e+00 -7.145043e-02 1.857711e-01 -1.143207e-01
    ##   [76,] 7.401386e-01 7.732391e-02 0.000000e+00 -5.213912e-02 1.355617e-01 -8.342259e-02
    ##   [77,] 1.901186e-01 6.497620e-01 1.601169e-01 -7.059481e-07 1.835465e-06 -1.129517e-06
    ##   [78,] 9.507972e-03 3.915353e-01 5.650874e-01  3.058744e-02 8.532977e-03 -5.251063e-03
    ##   [79,] 4.790022e-02 5.541880e-01 3.917960e-01  5.523181e-03 1.540801e-03 -9.481855e-04
    ##   [80,] 1.485621e-01 6.492084e-01 2.022073e-01  2.011146e-05 5.610494e-06 -3.452612e-06
    ##   [81,] 1.755127e-01 6.510337e-01 1.734535e-01  0.000000e+00 0.000000e+00  0.000000e+00
    ##   [82,] 4.622601e-01 4.939627e-01 3.365891e-02 -2.891482e-03 7.517853e-03 -4.626371e-03
    ##   [83,] 6.213424e-01 3.331147e-01 6.944838e-03 -1.103012e-02 2.867831e-02 -1.764819e-02
    ##   [84,] 7.322538e-01 1.617480e-01 8.534848e-05 -3.026664e-02 7.869327e-02 -4.842663e-02
    ##   [85,] 7.322538e-01 1.617480e-01 8.534848e-05 -3.026664e-02 7.869327e-02 -4.842663e-02
    ##   [86,] 7.175633e-01 4.583019e-02 0.000000e+00 -6.741910e-02 1.752897e-01 -1.078706e-01
    ##   [87,] 6.685226e-01 2.027000e-02 0.000000e+00 -8.809350e-02 2.290431e-01 -1.409496e-01
    ##   [88,] 3.469656e-01 0.000000e+00 0.000000e+00 -1.689510e-01 4.392727e-01 -2.703217e-01
    ##   [89,] 5.595776e-01 2.533750e-03 0.000000e+00 -1.215942e-01 3.161450e-01 -1.945508e-01
    ##   [90,] 6.308670e-01 1.087236e-02 0.000000e+00 -1.008138e-01 2.621159e-01 -1.613021e-01
    ##   [91,] 7.175633e-01 4.583019e-02 0.000000e+00 -6.741910e-02 1.752897e-01 -1.078706e-01
    ##   [92,] 3.348633e-01 0.000000e+00 0.000000e+00 -1.709663e-01 4.445123e-01 -2.735461e-01
    ##   [93,] 7.361224e-01 6.841125e-02 0.000000e+00 -5.581049e-02 1.451073e-01 -8.929678e-02
    ##   [94,] 7.401386e-01 7.732391e-02 0.000000e+00 -5.213912e-02 1.355617e-01 -8.342259e-02
    ##   [95,] 7.322538e-01 1.617480e-01 8.534848e-05 -3.026664e-02 7.869327e-02 -4.842663e-02
    ##   [96,] 6.643181e-01 2.782935e-01 3.161055e-03 -1.549652e-02 4.029096e-02 -2.479444e-02
    ##   [97,] 7.247748e-01 5.269408e-02 0.000000e+00 -6.346140e-02 1.649996e-01 -1.015382e-01
    ##   [98,] 6.888294e-01 2.428548e-01 1.618460e-03 -1.906005e-02 4.955612e-02 -3.049607e-02
    ##   [99,] 6.213424e-01 3.331147e-01 6.944838e-03 -1.103012e-02 2.867831e-02 -1.764819e-02
    ##  [100,] 7.309811e-01 6.021120e-02 0.000000e+00 -5.958822e-02 1.549294e-01 -9.534115e-02
    ##  [101,] 5.143201e-01 6.185913e-04 0.000000e+00 -1.333301e-01 3.466583e-01 -2.133282e-01
    ##  [102,] 4.399397e-01 0.000000e+00 0.000000e+00 -1.507231e-01 3.918799e-01 -2.411569e-01
    ##  [103,] 7.094908e-01 2.088806e-01 6.827879e-04 -2.313183e-02 6.014277e-02 -3.701094e-02
    ##  [104,] 7.361224e-01 6.841125e-02 0.000000e+00 -5.581049e-02 1.451073e-01 -8.929678e-02
    ##  [105,] 7.247748e-01 5.269408e-02 0.000000e+00 -6.346140e-02 1.649996e-01 -1.015382e-01
    ##  [106,] 6.173024e-01 8.551406e-03 0.000000e+00 -1.050410e-01 2.731066e-01 -1.680656e-01
    ##  [107,] 7.429701e-01 8.697889e-02 0.000000e+00 -4.858504e-02 1.263211e-01 -7.773606e-02
    ##  [108,] 7.258403e-01 1.768659e-01 2.023075e-04 -2.774578e-02 7.213902e-02 -4.439324e-02
    ##  [109,] 5.370084e-01 4.247942e-01 1.843527e-02 -5.647424e-03 1.468330e-02 -9.035878e-03
    ##  [110,] 1.755127e-01 6.510337e-01 1.734535e-01  0.000000e+00 0.000000e+00  0.000000e+00
    ##  [111,] 5.001739e-01 4.601311e-01 2.528844e-02 -4.116973e-03 1.070413e-02 -6.587156e-03
    ##  [112,] 3.850421e-01 5.551306e-01 5.555870e-02 -1.219845e-03 3.171596e-03 -1.951752e-03
    ##  [113,] 1.032260e-01 6.296073e-01 2.665654e-01  5.430122e-04 1.514841e-04 -9.322098e-05
    ##  [114,] 9.355512e-02 6.217356e-01 2.837545e-01  8.622882e-04 2.405525e-04 -1.480323e-04
    ##  [115,] 4.331256e-04 2.345827e-01 6.737676e-01  8.237771e-02 2.298091e-02 -1.414210e-02
    ##  [116,] 1.169439e-02 4.092609e-01 5.494038e-01  2.676872e-02 7.467669e-03 -4.595489e-03
    ##  [117,] 5.414069e-02 5.675633e-01 3.734858e-01  4.344130e-03 1.211882e-03 -7.457735e-04
    ##  [118,] 1.361885e-01 6.462115e-01 2.175249e-01  6.787653e-05 1.893551e-05 -1.165262e-05
    ##  [119,] 1.135412e-01 6.363505e-01 2.497603e-01  3.142463e-04 8.766528e-05 -5.394787e-05
    ##  [120,] 2.054359e-01 6.470621e-01 1.474822e-01 -5.647500e-06 1.468350e-05 -9.036000e-06
    ##  [121,] 1.616634e-01 6.508359e-01 1.874979e-01  2.513820e-06 7.012802e-07 -4.315570e-07
    ##  [122,] 7.094908e-01 2.088806e-01 6.827879e-04 -2.313183e-02 6.014277e-02 -3.701094e-02
    ##  [123,] 5.595776e-01 2.533750e-03 0.000000e+00 -1.215942e-01 3.161450e-01 -1.945508e-01
    ##  [124,] 6.996702e-01 2.256537e-01 1.084242e-03 -2.103029e-02 5.467875e-02 -3.364846e-02
    ##  [125,] 7.429701e-01 8.697889e-02 0.000000e+00 -4.858504e-02 1.263211e-01 -7.773606e-02
    ##  [126,] 4.691753e-01 3.958984e-05 0.000000e+00 -1.441564e-01 3.748067e-01 -2.306502e-01
    ##  [127,] 4.399397e-01 0.000000e+00 0.000000e+00 -1.507231e-01 3.918799e-01 -2.411569e-01
    ##  [128,] 7.175633e-01 4.583019e-02 0.000000e+00 -6.741910e-02 1.752897e-01 -1.078706e-01
    ##  [129,] 2.379742e-01 6.376257e-01 1.242420e-01 -4.518000e-05 1.174680e-04 -7.228800e-05
    ##  [130,] 3.277303e-01 5.933740e-01 7.709489e-02 -5.146241e-04 1.338023e-03 -8.233986e-04
    ##  [131,] 4.430426e-01 5.101596e-01 3.846061e-02 -2.382503e-03 6.194509e-03 -3.812005e-03
    ##  [132,] 2.550793e-01 6.310129e-01 1.135989e-01 -8.824086e-05 2.294262e-04 -1.411854e-04
    ##  [133,] 5.987513e-03 3.558339e-01 5.946831e-01  3.928079e-02 1.095816e-02 -6.743483e-03
    ##  [134,] 3.208945e-02 5.100656e-01 4.464429e-01  1.029719e-02 2.872605e-03 -1.767757e-03
    ##  [135,] 1.361885e-01 6.462115e-01 2.175249e-01  6.787653e-05 1.893551e-05 -1.165262e-05
    ##  [136,] 5.414069e-02 5.675633e-01 3.734858e-01  4.344130e-03 1.211882e-03 -7.457735e-04
    ##  [137,] 2.772004e-02 4.942266e-01 4.643770e-01  1.235112e-02 3.445590e-03 -2.120363e-03
    ##  [138,] 3.465108e-06 1.736295e-01 6.964905e-01  1.172916e-01 3.272084e-02 -2.013590e-02
    ##  [139,] 2.376647e-02 4.779227e-01 4.820763e-01  1.466145e-02 4.090105e-03 -2.516988e-03
    ##  [140,] 1.419268e-02 4.268228e-01 5.332046e-01  2.328182e-02 6.494927e-03 -3.996878e-03
    ##  [141,] 2.020791e-02 4.612138e-01 4.994848e-01  1.724330e-02 4.810362e-03 -2.960223e-03
    ##  [142,] 0.000000e+00 6.747509e-02 6.672711e-01  2.381202e-01 6.703191e-02 -3.989825e-02
    ##  [143,] 0.000000e+00 1.347375e-01 7.001983e-01  1.490539e-01 4.158819e-02 -2.557789e-02
    ##  [144,] 0.000000e+00 5.356385e-02 6.489891e-01  2.660123e-01 7.531139e-02 -4.387670e-02
    ##  [145,] 0.000000e+00 1.021261e-01 6.926121e-01  1.851268e-01 5.174830e-02 -3.161325e-02
    ##  [146,] 2.376647e-02 4.779227e-01 4.820763e-01  1.466145e-02 4.090105e-03 -2.516988e-03
    ##  [147,] 2.376647e-02 4.779227e-01 4.820763e-01  1.466145e-02 4.090105e-03 -2.516988e-03
    ##  [148,] 6.820161e-02 5.919538e-01 3.370609e-01  2.513971e-03 7.013223e-04 -4.315829e-04
    ##  [149,] 3.689532e-02 5.253786e-01 4.283311e-01  8.484651e-03 2.366963e-03 -1.456592e-03
    ##  [150,] 1.169439e-02 4.092609e-01 5.494038e-01  2.676872e-02 7.467669e-03 -4.595489e-03
    ##  [151,] 1.188491e-03 2.679347e-01 6.557166e-01  6.787721e-02 1.893570e-02 -1.165274e-02
    ##  [152,] 0.000000e+00 8.360759e-02 6.819474e-01  2.110543e-01 5.916178e-02 -3.577104e-02
    ##  [153,] 0.000000e+00 1.156979e-02 5.177193e-01  4.069232e-01 1.211866e-01 -5.739886e-02
    ##  [154,] 0.000000e+00 3.174751e-02 6.032344e-01  3.230241e-01 9.290820e-02 -5.091426e-02
    ##  [155,] 0.000000e+00 3.650231e-02 6.156951e-01  3.087152e-01 8.839404e-02 -4.930672e-02
    ##  [156,] 0.000000e+00 1.021261e-01 6.926121e-01  1.851268e-01 5.174830e-02 -3.161325e-02
    ##  [157,] 1.188491e-03 2.679347e-01 6.557166e-01  6.787721e-02 1.893570e-02 -1.165274e-02
    ##  [158,] 2.020791e-02 4.612138e-01 4.994848e-01  1.724330e-02 4.810362e-03 -2.960223e-03
    ##  [159,] 2.217603e-04 2.185351e-01 6.812050e-01  9.034448e-02 2.520340e-02 -1.550978e-02
    ##  [160,] 1.419268e-02 4.268228e-01 5.332046e-01  2.328182e-02 6.494927e-03 -3.996878e-03
    ##  [161,] 1.774082e-03 2.851189e-01 6.452152e-01  6.131317e-02 1.710453e-02 -1.052587e-02
    ##  [162,] 0.000000e+00 1.231950e-01 6.988587e-01  1.606504e-01 4.483900e-02 -2.754315e-02
    ##  [163,] 0.000000e+00 7.525327e-02 6.750852e-01  2.244647e-01 6.304278e-02 -3.784589e-02
    ##  [164,] 0.000000e+00 4.170947e-02 6.275081e-01  2.944179e-01 8.395266e-02 -4.758813e-02
    ##  [165,] 0.000000e+00 1.175839e-03 3.892491e-01  5.026405e-01 1.604133e-01 -5.347873e-02
    ##  [166,] 0.000000e+00 7.531488e-03 4.863371e-01  4.332079e-01 1.309251e-01 -5.800167e-02
    ##  [ reached 'max' / getOption("max.print") -- omitted 1660 rows ]
    ## attr(,"degree")
    ## [1] 3
    ## attr(,"knots")
    ## [1] 11.0 13.9 17.7 21.4 25.0
    ## attr(,"Boundary.knots")
    ## [1]  1.8 31.0
    ## attr(,"intercept")
    ## [1] FALSE
    ## attr(,"class")
    ## [1] "ns"     "basis"  "matrix"

``` r
df_valencia %>% 
    select(tmean) %>% 
    mutate(ns.tmean = ns(tmean, df = 6))
```

    ## # A tibble: 1,826 × 2
    ##    tmean ns.tmean[,"1"] [,"2"] [,"3"] [,"4"] [,"5"] [,"6"]
    ##    <dbl>          <dbl>  <dbl>  <dbl>  <dbl>  <dbl>  <dbl>
    ##  1  8.90          0.202      0      0 -0.185  0.481 -0.296
    ##  2  8.5           0.170      0      0 -0.185  0.481 -0.296
    ##  3 10.8           0.412      0      0 -0.157  0.407 -0.251
    ##  4  9.60          0.268      0      0 -0.180  0.468 -0.288
    ##  5  9.20          0.229      0      0 -0.184  0.477 -0.294
    ##  6  9.70          0.279      0      0 -0.179  0.465 -0.286
    ##  7  8.80          0.194      0      0 -0.185  0.481 -0.296
    ##  8  9.40          0.248      0      0 -0.182  0.473 -0.291
    ##  9  8.80          0.194      0      0 -0.185  0.481 -0.296
    ## 10  9.60          0.268      0      0 -0.180  0.468 -0.288
    ## # ℹ 1,816 more rows

### Generate working dataframes - 2 cities

``` r
wls <- list(df_valencia, df_london) %>% 
    set_names(c("valencia", "london")) %>% 
    map(\(data){
        
        wdf <- data %>% 
            mutate(across(.cols = c(month, year, dow),
                          as.factor),
                   # generate time-stratified strata
                   stratum = as.factor(year:month:dow),
                   # generate lag0 for temperature, humidity, and PM10
                   across(.cols = c(tmean, rh, pm10),
                          ~ dplyr::lag(.x, n = 0),
                          .names = "{.col}_l0"),
                   # generate lag1 for temperature, humidity, and PM10
                   across(.cols = c(tmean, rh, pm10),
                          ~ dplyr::lag(.x, n = 1),
                          .names = "{.col}_l1"),
                   # generate lag2 for temperature, humidity, and PM10
                   across(.cols = c(tmean, rh, pm10),
                          ~ dplyr::lag(.x, n = 2),
                          .names = "{.col}_l2"),
                   # generate lag3 for temperature, humidity, and PM10
                   across(.cols = c(tmean, rh, pm10),
                          ~ dplyr::lag(.x, n = 3),
                          .names = "{.col}_l3"),
                   l03tmean = (tmean_l0 + tmean_l1 + tmean_l2 + tmean_l3)/4,
                   l03rh = (rh_l0 + rh_l1 + rh_l2 + rh_l3)/4,
                   # generate averaged lag exposure for PM10 sale for a 10 ug/m3 increase
                   l01pm10 = ((pm10_l0 + pm10_l1)/2)/10,
                   # generate splines for temperature adjustment
                   ns.tmean = ns(l03tmean, df = 6),
                   # generate splines for humidity adjustment
                   ns.rh = ns(l03rh, df = 3))
        
        # Generate 'ind' = sum of events in each stratum
        df_ind <- data %>% 
                mutate(across(.cols = c(month, year, dow),
                              as.factor),
                       stratum = as.factor(year:month:dow)) %>%
                group_by(stratum) %>% 
                summarise(ind = sum(all))
        
        res <- wdf %>% 
            left_join(df_ind, by = join_by(stratum))
        
        return(res)
    })
```

Save working datasets

``` r
saveRDS(wls, here("note_lehuynh/working_df.RDS"))
```
